// Remix Deployment Script for PropertyNFT ERC1967Proxy
// Instructions: 
// 1. Copy this file to Remix IDE (scripts folder)
// 2. Right-click → "Compile and run script"
// 3. Confirm transaction in MetaMask

(async () => {
    try {
        console.log('Starting PropertyNFT Proxy Deployment...');
        
        // Configuration
        const implementationAddress = '0xC463C519c36A92f0354E64AF7cC0dFc3ccC588a2';
        const deployerAddress = '0xa5902Da508412B8782B5CD18DAf6C6956cAB19F9';
        const nftName = 'RWA Property NFT';
        const nftSymbol = 'RWAPROP';
        
        console.log('Implementation:', implementationAddress);
        console.log('Deployer:', deployerAddress);
        
        // Encode initialize calldata
        const initData = web3.eth.abi.encodeFunctionCall({
            name: 'initialize',
            type: 'function',
            inputs: [
                {type: 'address', name: 'initialOwner'},
                {type: 'string', name: 'name'},
                {type: 'string', name: 'symbol'}
            ]
        }, [deployerAddress, nftName, nftSymbol]);
        
        console.log('Encoded initialize data:', initData);
        
        // ERC1967Proxy ABI (constructor only)
        const proxyABI = [{
            "inputs": [
                {"internalType": "address", "name": "implementation", "type": "address"},
                {"internalType": "bytes", "name": "_data", "type": "bytes"}
            ],
            "stateMutability": "payable",
            "type": "constructor"
        }];
        
        // ERC1967Proxy bytecode (from OpenZeppelin)
        const proxyBytecode = '0x60806040526040516109e43803806109e483398101604081905261002291610408565b61002e82826000610035565b5050610557565b61003e83610100565b6040516001600160a01b038416907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a26000825111806100805750805b156100fb576100f9836001600160a01b0316635c60da1b6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156100c6573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906100ea9190610517565b836102a960201b6100291760201c565b505b505050565b610113816102d560201b6100551760201c565b6101725760405162461bcd60e51b815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b60648201526084015b60405180910390fd5b806101997f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc60001b6102e460201b6100641760201c565b80546001600160a01b0319166001600160a01b039290921691909117905550565b60606101ce838360405180606001604052806027815260200161097d602791396102e7565b9392505050565b6001600160a01b03163b151590565b90565b6060600080856001600160a01b0316856040516102fc9190610537565b600060405180830381855af49150503d8060008114610337576040519150601f19603f3d011682016040523d82523d6000602084013e61033c565b606091505b50915091506103548683836040518060200160405280600081525061035c565b9695505050505050565b6060831561036d575081610354565b8251156103775782518084602001fd5b8160405162461bcd60e51b81526004016101699190610553565b80516001600160a01b03811681146103a957600080fd5b919050565b634e487b7160e01b600052604160045260246000fd5b60005b838110156103df5781810151838201526020016103c7565b838111156100fb5750506000910152565b805160408051908101604052806002906020820280368337509192915050565b6000806040838503121561041b57600080fd5b61042483610392565b60208401519092506001600160401b038082111561044157600080fd5b818501915085601f83011261045557600080fd5b815181811115610467576104676103ae565b604051601f8201601f19908116603f0116810190838211818310171561048f5761048f6103ae565b816040528281528860208487010111156104a857600080fd5b6104b98360208301602088016103c4565b80955050505050509250929050565b6000815180845260208085019450808401835b838110156104f7578151875295820195908201906001016104db565b509495945050505050565b60006040825261051560408301856104c7565b82810360208401526103548185610390565b60006020828403121561052957600080fd5b6103ce82610392565b600082516105498184602087016103c4565b9190910192915050565b6020815260008251806020840152610572816040850160208701610392565b601f01601f19169190910160400192915050565b6103e180620005666000396000f3fe60806040526004361061005e5760003560e01c80635c60da1b116100435780635c60da1b146100a85780638f283970146100e6578063f851a440146101065761006d565b80633659cfe6146100755780634f1ef286146100955761006d565b3661006d5761006b61011b565b005b61006b61011b565b34801561008157600080fd5b5061006b61009036600461032c565b610135565b61006b6100a336600461035e565b610196565b3480156100b457600080fd5b506100bd610221565b60405173ffffffffffffffffffffffffffffffffffffffff909116815260200160405180910390f35b3480156100f257600080fd5b5061006b61010136600461032c565b610276565b34801561011257600080fd5b506100bd6102ba565b610123610318565b61013361012e610355565b61035f565b565b3373ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000000000000000000000000000000000000000000016141561018e5761018b8160405180602001604052806000815250600061037e565b50565b61018b61011b565b3373ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000161415610214576101dd836103a9565b6000825111806101ea5750815b1561020f5761020d836101fc84610414565b60405180602001604052806000815250610497565b505b505050565b61021c61011b565b505050565b60003373ffffffffffffffffffffffffffffffffffffffff7f00000000000000000000000000000000000000000000000000000000000000001614156102715761026c610355565b905090565b61027961011b565b90565b3373ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000000000000000000000000000000000000000000016141561018e5761018b816104f0565b60003373ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000000000000000000000000000000000000000000016141561027157507f000000000000000000000000000000000000000000000000000000000000000090565b3415610133576040517fb398979f00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60007f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5473ffffffffffffffffffffffffffffffffffffffff16919050565b6103878361054f565b6000825111806103945750805b1561021c5761020d838361059f565b7f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f6103d2610355565b6040805173ffffffffffffffffffffffffffffffffffffffff928316815291841660208301520160405180910390a161040a816105f5565b50505050565b60606104408383604051806060016040528060278152602001610385602791396106fe565b9392505050565b60006101ce838360405180606001604052806027815260200161097d602791396106fe565b73ffffffffffffffffffffffffffffffffffffffff163b151590565b6060600080856001600160a01b0316856040516104b4919061035e565b600060405180830381855af49150503d80600081146104ef576040519150601f19603f3d011682016040523d82523d6000602084013e6104f4565b606091505b509150915061050586838387610776565b9695505050505050565b60006105198261080e565b919050565b73ffffffffffffffffffffffffffffffffffffffff8116811461018b57600080fd5b60006020828403121561055257600080fd5b813561044081610524565b6000806040838503121561057057600080fd5b823561057b81610524565b9150602083013567ffffffffffffffff81111561059757600080fd5b8301601f810185136105a857600080fd5b80356105bb6105b682610880565b610851565b8181528660208385010111156105d057600080fd5b81602084016020830137600091810160200191909152949350505050565b803b61063a576040517f4c9c8ce300000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff821660048201526024015b60405180910390fd5b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80547fffffffffffffffffffffffff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff92909216919091179055565b606073ffffffffffffffffffffffffffffffffffffffff84163b610734576040517f9996b31500000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff85166004820152602401610631565b6000808573ffffffffffffffffffffffffffffffffffffffff16856040516107009190610537565b600060405180830381855af49150503d806000811461073b576040519150601f19603f3d011682016040523d82523d6000602084013e610740565b606091505b50915091506107508683836108a8565b9695505050505050565b60608161079e57505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b81156107c857806107b2816108dd565b91506107c19050600a83610915565b91506107a2565b60008167ffffffffffffffff8111156107e3576107e36103ae565b6040519080825280601f01601f19166020018201604052801561080d576020820181803683370190505b5092915050565b803b1561082b576001821115610826576000199190565b505050565b60405162461bcd60e51b815260206004820152602360248201527f555550535570677261646561626c653a206d757374206e6f742062652063616c60448201527f6c65640000000000000000000000000000000000000000000000000000000000606482015260840160405180910390fd5b919050565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe016810167ffffffffffffffff811182821017156108ce576108ce6103ae565b604052919050565b803b15610945576040517f9996b31500000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff85166004820152602401610631565b50505050565b73ffffffffffffffffffffffffffffffffffffffff8116811461018b57600080fd5b60006020828403121561097f57600080fd5b813561044081610924565b600082601f83011261099b57600080fd5b813567ffffffffffffffff8111156109b5576109b56103ae565b6109e660207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f84011601610851565b8181528460208386010111156109fb57600080fd5b816020850160208301376000918101602001919091529392505050565b60008060408385031215610a2b57600080fd5b8235610a3681610924565b9150602083013567ffffffffffffffff811115610a5257600080fd5b610a5e8582860161098a565b9150509250929050565b600082516105498184602087016103c4565b60208152600082518060208401526105728160408501602087016103c4565b634e487b7160e01b600052604160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b6000600019821415610afd577f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b5060010190565b600082610b33577f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b50049056';
        
        // Create contract instance
        const ProxyContract = new web3.eth.Contract(proxyABI);
        
        // Deploy
        console.log('Sending deployment transaction...');
        const accounts = await web3.eth.getAccounts();
        
        const deployTx = ProxyContract.deploy({
            data: proxyBytecode,
            arguments: [implementationAddress, initData]
        });
        
        const proxyInstance = await deployTx.send({
            from: accounts[0],
            gas: 3000000
        });
        
        const proxyAddress = proxyInstance.options.address;
        
        console.log('');
        console.log('=============================================');
        console.log('✅ DEPLOYMENT SUCCESSFUL!');
        console.log('=============================================');
        console.log('PropertyNFT Implementation:', implementationAddress);
        console.log('PropertyNFT Proxy (MAIN)  :', proxyAddress);
        console.log('=============================================');
        console.log('');
        console.log('RECORD THIS PROXY ADDRESS IN AMOY_DEPLOYMENT_RECORD_V3.md!');
        console.log('USE THE PROXY ADDRESS FOR ALL INTERACTIONS!');
        
        return proxyAddress;
        
    } catch (error) {
        console.error('❌ Deployment failed:', error.message);
        throw error;
    }
})();

